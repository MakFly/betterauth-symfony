name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Clone betterauth-core (path dependency)
        run: git clone --depth 1 https://github.com/MakFly/betterauth-core.git ../betterauth-core

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: json, openssl, pdo, pdo_sqlite
          tools: composer:v2

      - name: Validate composer.json
        run: composer validate --strict

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --no-dev

      - name: Run tests
        run: |
          composer install --prefer-dist --no-progress --no-interaction
          vendor/bin/phpunit

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "## Changes since $PREVIOUS_TAG" > RELEASE_NOTES.md
            git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD >> RELEASE_NOTES.md
          else
            echo "## Initial Release" > RELEASE_NOTES.md
            echo "First release of BetterAuth Symfony Bundle" >> RELEASE_NOTES.md
          fi

          echo "" >> RELEASE_NOTES.md
          echo "### Installation" >> RELEASE_NOTES.md
          echo '```bash' >> RELEASE_NOTES.md
          echo "composer require betterauth/symfony-bundle:${{ github.ref_name }}" >> RELEASE_NOTES.md
          echo '```' >> RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true

  publish-packagist:
    name: Update Packagist
    runs-on: ubuntu-latest
    needs: release

    steps:
      - name: Notify Packagist
        run: |
          # Packagist will auto-update via webhook, but you can also trigger manually
          echo "Release ${{ github.ref_name }} published. Packagist will be updated automatically via webhook."
          echo "If you haven't set up the webhook, visit https://packagist.org/packages/betterauth/symfony-bundle"
