services:
    _defaults:
        autowire: true
        autoconfigure: true
        public: false

    # Core services
    BetterAuth\Core\PasswordHasher:
        public: true

    BetterAuth\Core\TokenService:
        arguments:
            $secretKey: '%better_auth.secret%'
        public: true

    BetterAuth\Core\Config\AuthConfig:
        factory: ['BetterAuth\Core\Config\AuthConfig', 'forMonolith']
        arguments:
            $secretKey: '%better_auth.secret%'
        public: true

    # Plugin System
    BetterAuth\Core\Plugin\PluginManager:
        arguments:
            $config: '@BetterAuth\Core\Config\AuthConfig'
        public: true

    BetterAuth\Symfony\Plugin\SymfonyPluginLoader:
        arguments:
            $pluginManager: '@BetterAuth\Core\Plugin\PluginManager'
            $eventDispatcher: '@Symfony\Contracts\EventDispatcher\EventDispatcherInterface'
        public: true

    # Session management
    BetterAuth\Core\SessionService:
        arguments:
            $sessionRepository: '@BetterAuth\Core\Interfaces\SessionRepositoryInterface'
            $sessionLifetime: 604800 # 7 days
            $logger: '@?logger'
        public: true
        tags:
            - { name: 'monolog.logger', channel: 'better_auth' }

    # Authentication managers
    BetterAuth\Core\SessionAuthManager:
        arguments:
            $userRepository: '@BetterAuth\Core\Interfaces\UserRepositoryInterface'
            $sessionService: '@BetterAuth\Core\SessionService'
            $passwordHasher: '@BetterAuth\Core\PasswordHasher'
            $rateLimiter: '@?BetterAuth\Core\Interfaces\RateLimiterInterface'
            $logger: '@?logger'
        public: true
        tags:
            - { name: 'monolog.logger', channel: 'better_auth' }

    BetterAuth\Core\TokenAuthManager:
        arguments:
            $userRepository: '@BetterAuth\Core\Interfaces\UserRepositoryInterface'
            $refreshTokenRepository: '@BetterAuth\Core\Interfaces\RefreshTokenRepositoryInterface'
            $tokenService: '@BetterAuth\Core\TokenService'
            $passwordHasher: '@BetterAuth\Core\PasswordHasher'
            $config: '@BetterAuth\Core\Config\AuthConfig'
            $logger: '@?logger'
        public: true
        tags:
            - { name: 'monolog.logger', channel: 'better_auth' }

    BetterAuth\Core\AuthManager:
        arguments:
            $config: '@BetterAuth\Core\Config\AuthConfig'
            $sessionAuthManager: '@BetterAuth\Core\SessionAuthManager'
            $tokenAuthManager: '@BetterAuth\Core\TokenAuthManager'
        public: true

    # Interface aliases for dependency injection
    BetterAuth\Core\Interfaces\AuthManagerInterface:
        alias: BetterAuth\Core\AuthManager

    BetterAuth\Core\Interfaces\SessionAuthManagerInterface:
        alias: BetterAuth\Core\SessionAuthManager

    # TokenManager - High-level token management (like Lexik's JWTManager)
    # Use this interface in custom controllers to create/decode tokens
    BetterAuth\Core\TokenManager:
        arguments:
            $tokenSigner: '@BetterAuth\Core\TokenService'
            $userRepository: '@BetterAuth\Core\Interfaces\UserRepositoryInterface'
            $refreshTokenRepository: '@BetterAuth\Core\Interfaces\RefreshTokenRepositoryInterface'
            $config: '@BetterAuth\Core\Config\AuthConfig'
        public: true

    BetterAuth\Core\Interfaces\TokenManagerInterface:
        alias: BetterAuth\Core\TokenManager

    # ============================================
    # Token Extractors (like Lexik)
    # ============================================
    # Extracts tokens from HTTP requests

    BetterAuth\Symfony\TokenExtractor\AuthorizationHeaderTokenExtractor:
        arguments:
            $prefix: 'Bearer'
            $name: 'Authorization'
        public: true

    BetterAuth\Symfony\TokenExtractor\CookieTokenExtractor:
        arguments:
            $name: 'access_token'
        public: true

    BetterAuth\Symfony\TokenExtractor\QueryParameterTokenExtractor:
        arguments:
            $name: 'bearer'
        public: true

    # ChainTokenExtractor - Combines multiple extractors
    # By default, tries Authorization header first, then cookies
    BetterAuth\Symfony\TokenExtractor\ChainTokenExtractor:
        arguments:
            $extractors:
                - '@BetterAuth\Symfony\TokenExtractor\AuthorizationHeaderTokenExtractor'
                - '@BetterAuth\Symfony\TokenExtractor\CookieTokenExtractor'
        public: true

    BetterAuth\Symfony\TokenExtractor\TokenExtractorInterface:
        alias: BetterAuth\Symfony\TokenExtractor\ChainTokenExtractor

    # TokenService Decorator - Enables token modification events (like Lexik)
    BetterAuth\Symfony\Service\EventDispatchingTokenService:
        decorates: BetterAuth\Core\TokenService
        arguments:
            $inner: '@.inner'
            $dispatcher: '@Symfony\Contracts\EventDispatcher\EventDispatcherInterface'
            $userRepository: '@BetterAuth\Core\Interfaces\UserRepositoryInterface'

    # Security integration for Symfony Security component
    # Dispatches 8 events compatible with LexikJWTAuthenticationBundle
    BetterAuth\Symfony\Security\BetterAuthAuthenticator:
        arguments:
            $authManager: '@BetterAuth\Core\TokenAuthManager'
            $dispatcher: '@Symfony\Contracts\EventDispatcher\EventDispatcherInterface'
            $tokenService: '@BetterAuth\Core\TokenService'
            $debug: '%kernel.debug%'
            $tokenExtractor: '@BetterAuth\Symfony\TokenExtractor\TokenExtractorInterface'
        public: true
        tags:
            - { name: 'monolog.logger', channel: 'better_auth' }

    BetterAuth\Symfony\Security\BetterAuthUserProvider:
        arguments:
            $userRepository: '@BetterAuth\Core\Interfaces\UserRepositoryInterface'
        public: true

    # OAuth Manager - Manages OAuth providers (Google, GitHub, etc.)
    # Supports both session-based and token-based auth modes
    BetterAuth\Providers\OAuthProvider\OAuthManager:
        arguments:
            $userRepository: '@BetterAuth\Core\Interfaces\UserRepositoryInterface'
            $sessionService: '@BetterAuth\Core\SessionService'
            $authConfig: '@BetterAuth\Core\Config\AuthConfig'
            $tokenManager: '@?BetterAuth\Core\Interfaces\TokenManagerInterface'
        public: true

    # ID Converter - Automatic UUID/INT detection and conversion
    BetterAuth\Symfony\Service\UserIdConverter:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
            $userClass: 'App\Entity\User'
        public: true

    # Doctrine storage adapters - Auto-configured
    BetterAuth\Symfony\Storage\Doctrine\DoctrineUserRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
        public: true

    BetterAuth\Symfony\Storage\Doctrine\DoctrineSessionRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
        public: true

    BetterAuth\Symfony\Storage\Doctrine\DoctrineRefreshTokenRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
        public: true

    # Map BetterAuth interfaces to Doctrine implementations
    BetterAuth\Core\Interfaces\UserRepositoryInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrineUserRepository

    BetterAuth\Core\Interfaces\SessionRepositoryInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrineSessionRepository

    BetterAuth\Core\Interfaces\RefreshTokenRepositoryInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrineRefreshTokenRepository

    # Account Linking
    BetterAuth\Symfony\Storage\Doctrine\DoctrineAccountLinkRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
        public: true

    BetterAuth\Core\Interfaces\AccountLinkRepositoryInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrineAccountLinkRepository

    BetterAuth\Providers\AccountLinkProvider\AccountLinkProvider:
        arguments:
            $accountLinkRepository: '@BetterAuth\Core\Interfaces\AccountLinkRepositoryInterface'
        public: true

    # Guest Sessions
    BetterAuth\Symfony\Storage\Doctrine\DoctrineGuestSessionRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
        public: true

    BetterAuth\Core\Interfaces\GuestSessionRepositoryInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrineGuestSessionRepository

    BetterAuth\Providers\GuestSessionProvider\GuestSessionProvider:
        arguments:
            $guestSessionRepository: '@BetterAuth\Core\Interfaces\GuestSessionRepositoryInterface'
            $userRepository: '@BetterAuth\Core\Interfaces\UserRepositoryInterface'
            $sessionLifetime: 86400
        public: true

    # Device Management
    BetterAuth\Symfony\Storage\Doctrine\DoctrineDeviceInfoRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
        public: true

    BetterAuth\Symfony\Storage\Doctrine\DoctrineSessionActivityRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
        public: true

    BetterAuth\Core\Interfaces\DeviceInfoRepositoryInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrineDeviceInfoRepository

    BetterAuth\Core\Interfaces\SessionActivityRepositoryInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrineSessionActivityRepository

    BetterAuth\Providers\DeviceManagementProvider\DeviceDetector:
        public: true

    BetterAuth\Providers\DeviceManagementProvider\GeolocationService:
        public: true

    BetterAuth\Providers\DeviceManagementProvider\DeviceFingerprintService:
        public: true

    BetterAuth\Providers\DeviceManagementProvider\SessionManagerProvider:
        arguments:
            $deviceInfoRepository: '@BetterAuth\Core\Interfaces\DeviceInfoRepositoryInterface'
            $sessionActivityRepository: '@BetterAuth\Core\Interfaces\SessionActivityRepositoryInterface'
            $deviceDetector: '@BetterAuth\Providers\DeviceManagementProvider\DeviceDetector'
            $geolocationService: '@BetterAuth\Providers\DeviceManagementProvider\GeolocationService'
            $fingerprintService: '@BetterAuth\Providers\DeviceManagementProvider\DeviceFingerprintService'
        public: true

    # Security Enhancements
    BetterAuth\Symfony\Storage\Doctrine\DoctrineSecurityEventRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
        public: true

    BetterAuth\Symfony\Storage\Doctrine\DoctrineSuspiciousActivityRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
        public: true

    BetterAuth\Core\Interfaces\SecurityEventRepositoryInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrineSecurityEventRepository

    BetterAuth\Core\Interfaces\SuspiciousActivityRepositoryInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrineSuspiciousActivityRepository

    BetterAuth\Providers\SecurityProvider\SecurityMonitor:
        arguments:
            $securityEventRepository: '@BetterAuth\Core\Interfaces\SecurityEventRepositoryInterface'
            $geolocationService: '@BetterAuth\Providers\DeviceManagementProvider\GeolocationService'
        public: true

    BetterAuth\Providers\SecurityProvider\ThreatDetector:
        arguments:
            $suspiciousActivityRepository: '@BetterAuth\Core\Interfaces\SuspiciousActivityRepositoryInterface'
            $deviceInfoRepository: '@BetterAuth\Core\Interfaces\DeviceInfoRepositoryInterface'
            $geolocationService: '@BetterAuth\Providers\DeviceManagementProvider\GeolocationService'
            $fingerprintService: '@BetterAuth\Providers\DeviceManagementProvider\DeviceFingerprintService'
        public: true

    BetterAuth\Providers\SecurityProvider\AuditLogger:
        arguments:
            $securityMonitor: '@BetterAuth\Providers\SecurityProvider\SecurityMonitor'
            $logger: '@?logger'
        public: true

    # OpenAPI decorator for API Platform integration
    # Automatically adds BetterAuth authentication endpoints to OpenAPI docs
    # The auth path prefix is auto-detected from routes or can be configured via openapi.path_prefix
    BetterAuth\Symfony\OpenApi\AuthenticationDecorator:
        decorates: 'api_platform.openapi.factory'
        arguments:
            $decorated: '@.inner'
            # $authPathPrefix is optionally injected by BetterAuthExtension (null = auto-detect from routes)
            $router: '@Symfony\Component\Routing\RouterInterface'
        autoconfigure: true

    # Email Sender - Symfony Mailer implementation
    BetterAuth\Symfony\Service\SymfonyMailerEmailSender:
        arguments:
            $mailer: '@Symfony\Component\Mailer\MailerInterface'
            $fromEmail: 'noreply@example.com'
            $fromName: 'BetterAuth'
        public: true

    BetterAuth\Core\Interfaces\EmailSenderInterface:
        alias: BetterAuth\Symfony\Service\SymfonyMailerEmailSender

    # Email Verification Provider
    BetterAuth\Symfony\Storage\Doctrine\DoctrineEmailVerificationRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
        public: true

    BetterAuth\Core\Interfaces\EmailVerificationStorageInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrineEmailVerificationRepository

    BetterAuth\Providers\EmailVerificationProvider\EmailVerificationProvider:
        arguments:
            $userRepository: '@BetterAuth\Core\Interfaces\UserRepositoryInterface'
            $verificationStorage: '@BetterAuth\Core\Interfaces\EmailVerificationStorageInterface'
            $emailSender: '@BetterAuth\Core\Interfaces\EmailSenderInterface'
            $rateLimiter: '@?BetterAuth\Core\Interfaces\RateLimiterInterface'
        public: true

    # Magic Link Provider
    BetterAuth\Symfony\Storage\Doctrine\DoctrineMagicLinkRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
        public: true

    BetterAuth\Core\Interfaces\MagicLinkStorageInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrineMagicLinkRepository

    BetterAuth\Providers\MagicLinkProvider\MagicLinkProvider:
        arguments:
            $userRepository: '@BetterAuth\Core\Interfaces\UserRepositoryInterface'
            $magicLinkStorage: '@BetterAuth\Core\Interfaces\MagicLinkStorageInterface'
            $emailSender: '@BetterAuth\Core\Interfaces\EmailSenderInterface'
            $sessionService: '@BetterAuth\Core\SessionService'
            $authConfig: '@BetterAuth\Core\Config\AuthConfig'
            $tokenManager: '@?BetterAuth\Core\Interfaces\TokenManagerInterface'
            $rateLimiter: '@?BetterAuth\Core\Interfaces\RateLimiterInterface'
            $logger: '@?logger'
        public: true
        tags:
            - { name: 'monolog.logger', channel: 'better_auth' }

    # Password Reset Provider
    BetterAuth\Symfony\Storage\Doctrine\DoctrinePasswordResetRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
        public: true

    BetterAuth\Core\Interfaces\PasswordResetStorageInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrinePasswordResetRepository

    BetterAuth\Providers\PasswordResetProvider\PasswordResetProvider:
        arguments:
            $userRepository: '@BetterAuth\Core\Interfaces\UserRepositoryInterface'
            $passwordResetStorage: '@BetterAuth\Core\Interfaces\PasswordResetStorageInterface'
            $emailSender: '@BetterAuth\Core\Interfaces\EmailSenderInterface'
            $authManager: '@BetterAuth\Core\AuthManager'
            $rateLimiter: '@?BetterAuth\Core\Interfaces\RateLimiterInterface'
        public: true

    # TOTP Provider
    BetterAuth\Symfony\Storage\Doctrine\DoctrineTotpRepository:
        arguments:
            $entityManager: '@Doctrine\ORM\EntityManagerInterface'
            $idConverter: '@BetterAuth\Symfony\Service\UserIdConverter'
        public: true

    BetterAuth\Core\Interfaces\TotpStorageInterface:
        alias: BetterAuth\Symfony\Storage\Doctrine\DoctrineTotpRepository

    BetterAuth\Providers\TotpProvider\TotpProvider:
        arguments:
            $totpStorage: '@BetterAuth\Core\Interfaces\TotpStorageInterface'
            $issuer: 'BetterAuth'
            $logger: '@?logger'
        public: true
        tags:
            - { name: 'monolog.logger', channel: 'better_auth' }

    # Commands are registered in commands.yaml

    # ============================================
    # Symfony 7.3 Modern Features
    # ============================================

    # CurrentUser ValueResolver - Automatically injects authenticated User into controllers
    # Usage: public function action(#[CurrentUser] User $user): JsonResponse
    BetterAuth\Symfony\Security\ValueResolver\CurrentUserResolver:
        arguments:
            $authManager: '@BetterAuth\Core\AuthManager'
        tags:
            - { name: controller.argument_value_resolver, priority: 150 }

    # AuthExceptionListener - Converts auth exceptions to JSON responses
    # Handles: AuthenticationException (401), ValidationException (400)
    BetterAuth\Symfony\EventListener\AuthExceptionListener:
        arguments:
            $logger: '@?logger'
        tags:
            - { name: kernel.event_listener, event: kernel.exception, priority: 10 }
            - { name: 'monolog.logger', channel: 'better_auth' }

    # ============================================
    # Built-in Auth Controllers
    # ============================================
    # These controllers are auto-loaded via routes.yaml

    BetterAuth\Symfony\Controller\CredentialsController:
        arguments:
            $authManager: '@BetterAuth\Core\AuthManager'
            $totpProvider: '@BetterAuth\Providers\TotpProvider\TotpProvider'
            $logger: '@?logger'
        tags: ['controller.service_arguments']

    BetterAuth\Symfony\Controller\TokenController:
        arguments:
            $authManager: '@BetterAuth\Core\AuthManager'
        tags: ['controller.service_arguments']

    BetterAuth\Symfony\Controller\SessionController:
        arguments:
            $authManager: '@BetterAuth\Core\AuthManager'
        tags: ['controller.service_arguments']

    BetterAuth\Symfony\Controller\OAuthController:
        arguments:
            $authManager: '@BetterAuth\Core\AuthManager'
            $oauthManager: '@BetterAuth\Providers\OAuthProvider\OAuthManager'
            $totpProvider: '@BetterAuth\Providers\TotpProvider\TotpProvider'
            $logger: '@?logger'
        tags: ['controller.service_arguments']

    BetterAuth\Symfony\Controller\TwoFactorController:
        arguments:
            $authManager: '@BetterAuth\Core\AuthManager'
            $totpProvider: '@BetterAuth\Providers\TotpProvider\TotpProvider'
        tags: ['controller.service_arguments']

    BetterAuth\Symfony\Controller\PasswordResetController:
        arguments:
            $passwordResetProvider: '@BetterAuth\Providers\PasswordResetProvider\PasswordResetProvider'
            $logger: '@?logger'
        tags: ['controller.service_arguments']

    BetterAuth\Symfony\Controller\EmailVerificationController:
        arguments:
            $authManager: '@BetterAuth\Core\AuthManager'
            $emailVerificationProvider: '@BetterAuth\Providers\EmailVerificationProvider\EmailVerificationProvider'
            $logger: '@?logger'
        tags: ['controller.service_arguments']

    BetterAuth\Symfony\Controller\MagicLinkController:
        arguments:
            $magicLinkProvider: '@BetterAuth\Providers\MagicLinkProvider\MagicLinkProvider'
            $logger: '@?logger'
        tags: ['controller.service_arguments']

    BetterAuth\Symfony\Controller\GuestSessionController:
        arguments:
            $guestSessionProvider: '@BetterAuth\Providers\GuestSessionProvider\GuestSessionProvider'
            $authManager: '@BetterAuth\Core\AuthManager'
        tags: ['controller.service_arguments']
