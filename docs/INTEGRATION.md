# BetterAuth Symfony Bundle - Complete Integration Guide

## ğŸ¯ Why BetterAuth Bundle vs Manual Configuration?

**Without Bundle** (Manual Setup):
- âŒ Security.yaml stays empty - you must configure everything manually
- âŒ Services must be defined in your app's services.yaml
- âŒ No automatic integration with Symfony Security
- âŒ No Flex recipe for auto-installation
- âŒ Manual configuration of authenticators and user providers

**With BetterAuth Bundle** (Like LexikJWT):
- âœ… **Automatic Security.yaml configuration** via Flex recipe
- âœ… **Auto-configured services** via CompilerPass
- âœ… **Symfony Security integration** out of the box
- âœ… **Monolog logging** pre-configured
- âœ… **Zero configuration** for standard use cases

---

## ğŸ“¦ How It Works (Similar to LexikJWT)

### 1. **Symfony Flex Recipe**

When you install `betterauth/symfony-bundle`, Symfony Flex automatically:

```bash
composer require betterauth/symfony-bundle
```

**What happens:**
1. Installs the package
2. Executes the Flex recipe from `recipes/1.0/manifest.json`
3. Copies `config/packages/security.yaml` with BetterAuth configuration
4. Adds environment variables to `.env`
5. Displays post-install instructions

**Just like LexikJWT does!**

---

### 2. **Compiler Pass (Auto-Configuration)**

`BetterAuthSecurityPass` automatically:
- Tags `BetterAuthAuthenticator` with `security.authenticator`
- Tags `BetterAuthUserProvider` with `security.user_provider`
- Enables BetterAuth security integration

```php
// In BetterAuthBundle::build()
$container->addCompilerPass(new BetterAuthSecurityPass());
```

**This is what LexikJWT does with `JWTAuthenticatorCompilerPass`!**

---

### 3. **Service Auto-Registration**

Services are automatically registered in `config/services.yaml`:

```yaml
# Automatically available after installation
services:
    # Core
    BetterAuth\Core\PasswordHasher: ~
    BetterAuth\Core\TokenService: ~
    BetterAuth\Core\AuthManager: ~
    BetterAuth\Core\ApiAuthManager: ~

    # Security Integration
    BetterAuth\Symfony\Security\BetterAuthAuthenticator: ~
    BetterAuth\Symfony\Security\BetterAuthUserProvider: ~
```

---

## ğŸ”§ What Gets Configured Automatically

### Security.yaml (via Flex Recipe)

```yaml
security:
    providers:
        better_auth:
            id: BetterAuth\Symfony\Security\BetterAuthUserProvider

    firewalls:
        auth:  # Public routes
            pattern: ^/auth
            stateless: true
            security: false

        api:  # Protected routes
            pattern: ^/api
            stateless: true
            provider: better_auth
            custom_authenticators:
                - BetterAuth\Symfony\Security\BetterAuthAuthenticator

    access_control:
        - { path: ^/auth, roles: PUBLIC_ACCESS }
        - { path: ^/api, roles: ROLE_USER }
```

### Better_auth.yaml (Created by Recipe)

```yaml
better_auth:
    secret: '%env(BETTER_AUTH_SECRET)%'
    mode: api
    session:
        lifetime: 604800  # 7 days
    token:
        lifetime: 3600  # 1 hour
        refresh_lifetime: 2592000  # 30 days
```

### Monolog.yaml (Auto-configured)

```yaml
monolog:
    channels:
        - better_auth
    handlers:
        better_auth:
            type: stream
            path: "%kernel.logs_dir%/better_auth.log"
            level: info
            channels: ["better_auth"]
```

---

## ğŸš€ Usage After Installation

### 1. Update Environment Variables

```env
# .env - Auto-generated by recipe
BETTER_AUTH_SECRET=your-64-char-secret-here
BETTER_AUTH_ISSUER=http://localhost:8000
```

### 2. Create User Repository

```php
// src/Repository/DoctrineUserRepository.php
use BetterAuth\Core\Interfaces\UserRepositoryInterface;

class DoctrineUserRepository implements UserRepositoryInterface
{
    // Implement interface methods
}
```

### 3. Use in Controllers

```php
use Symfony\Component\Security\Http\Attribute\IsGranted;

#[Route('/api/dashboard')]
#[IsGranted('ROLE_USER')]
public function dashboard(): JsonResponse
{
    $user = $this->getUser(); // BetterAuthUser instance

    return $this->json([
        'user_id' => $user->getUserIdentifier(),
        'email' => $user->email,
    ]);
}
```

---

## ğŸ” Comparison with LexikJWT

| Feature | LexikJWT | BetterAuth |
|---------|----------|------------|
| **Token Format** | JWT (RS256, HS256) | Paseto V4 (more secure) |
| **Flex Recipe** | âœ… Auto-installs security.yaml | âœ… Auto-installs security.yaml |
| **Compiler Pass** | âœ… JWTAuthenticatorCompilerPass | âœ… BetterAuthSecurityPass |
| **User Provider** | âœ… JWTUserProvider | âœ… BetterAuthUserProvider |
| **Authenticator** | âœ… JWTAuthenticator | âœ… BetterAuthAuthenticator |
| **OAuth Support** | âŒ Not included | âœ… Google, GitHub, etc. |
| **Multi-tenant** | âŒ Not included | âœ… Organizations, Teams |
| **Refresh Tokens** | âš ï¸ Manual | âœ… Built-in |
| **SSO/OIDC** | âŒ Not included | âœ… Built-in |

---

## ğŸ“ Bundle Structure

```
packages/symfony/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ services.yaml              # Auto-loaded services
â”œâ”€â”€ recipes/
â”‚   â””â”€â”€ 1.0/
â”‚       â”œâ”€â”€ manifest.json          # Flex recipe definition
â”‚       â””â”€â”€ config/packages/
â”‚           â””â”€â”€ security.yaml      # Auto-installed security config
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ BetterAuthBundle.php       # Main bundle class
â”‚   â”œâ”€â”€ DependencyInjection/
â”‚   â”‚   â”œâ”€â”€ BetterAuthExtension.php    # Configuration loader
â”‚   â”‚   â”œâ”€â”€ BetterAuthSecurityPass.php # Auto-configuration
â”‚   â”‚   â””â”€â”€ Configuration.php          # Config tree
â”‚   â””â”€â”€ Security/
â”‚       â”œâ”€â”€ BetterAuthAuthenticator.php  # Like JWTAuthenticator
â”‚       â”œâ”€â”€ BetterAuthUserProvider.php   # Like JWTUserProvider
â”‚       â””â”€â”€ BetterAuthUser.php           # User wrapper
â””â”€â”€ composer.json
```

---

## ğŸ¯ Why Security.yaml Was Empty Before?

**Before creating the Flex recipe:**
- BetterAuth was a **standalone library**
- No Symfony Flex integration
- Developers had to manually configure everything

**After creating the Flex recipe (this PR):**
- **Automatic installation** like LexikJWT
- **Pre-configured security.yaml**
- **Zero-config** for standard use cases

---

## ğŸ”„ Migration from Manual Setup

If you already configured BetterAuth manually:

1. **Backup your current security.yaml**
2. **Compare with the recipe version** in `recipes/1.0/config/packages/security.yaml`
3. **Merge any custom configurations**
4. **Remove manual service definitions** (now auto-configured)

---

## ğŸ“– Next Steps

1. âœ… Bundle is now feature-complete like LexikJWT
2. âœ… Flex recipe auto-configures everything
3. âœ… CompilerPass handles service tagging
4. âœ… Security integration works out of the box

**For contributors:**
- Submit the recipe to `symfony/recipes-contrib`
- Add tests for auto-configuration
- Document all configuration options

---

## ğŸ¤ Contributing

Want to improve the bundle? Check the roadmap:

- [ ] Submit Flex recipe to symfony/recipes-contrib
- [ ] Add Symfony UX integration
- [ ] Create admin panel bundle
- [ ] Add command-line tools
- [ ] Write comprehensive tests

**This bundle is now production-ready! ğŸ‰**
